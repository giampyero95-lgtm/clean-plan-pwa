// 1. RENDERING AGGIORNATO (con nuova colonna e icone)
function renderCleanTasks() {
    const planner = document.getElementById("planner-container");
    const list = document.getElementById("list-table-body");
    const agenda = document.getElementById("agenda-settimanale");
    
    planner.innerHTML = [...new Set(cleanTasks.map(t => t.stanza))].map(s => `
        <div class="stanza-section"><h3><i class="fas fa-door-open"></i> ${s}</h3>
        ${cleanTasks.filter(t => t.stanza === s).map(t => {
            const en = calcolaEnergia(t);
            return `<div class="clean-card">
            <strong>${t.nome}</strong><small style="opacity:0.7">Manca: ${en.rim} gg</small>
            <div class="energy-container-wrap"><div style="height:100%; width:${100-en.perc}%; background:${en.col}; transition:0.5s"></div></div>
            <button onclick="segnaTaskFatto('${t.id}')" style="width:100%; border:none; background:var(--primary); color:white; padding:8px; border-radius:8px; cursor:pointer;">Fatto</button></div>`;
        }).join('')}</div>`).join('');

    list.innerHTML = cleanTasks.map(t => {
        const en = calcolaEnergia(t);
        return `<tr>
            <td><strong>${t.nome}</strong></td>
            <td>${t.stanza}</td>
            <td>Ogni ${t.freq} gg</td>
            <td>${t.ultima || '-'}</td>
            <td><div class="energy-container-wrap" style="width:80px; margin:0"><div style="height:100%; width:${100-en.perc}%; background:${en.col}"></div></div></td>
            <td>
                <button onclick="segnaTaskFatto('${t.id}')" style="border:none; color:#27ae60; background:none; cursor:pointer; font-size:1.1rem;" title="Fatto"><i class="fas fa-check-circle"></i></button>
                <button onclick="apriModificaTask('${t.id}')" style="border:none; color:#7f8c8d; background:none; cursor:pointer; font-size:1.1rem; margin-left:8px;" title="Modifica"><i class="fas fa-pencil-alt"></i></button>
                <button onclick="eliminaTask('${t.id}')" style="border:none; color:#e74c3c; background:none; cursor:pointer; font-size:1.1rem; margin-left:8px;" title="Elimina"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');
}

// 2. FUNZIONE PER APRIRE IL POP-UP DI MODIFICA
window.apriModificaTask = (id) => {
    const t = cleanTasks.find(task => task.id === id);
    document.getElementById('edit-t-id').value = t.id;
    document.getElementById('edit-t-nome').value = t.nome;
    document.getElementById('edit-t-stanza').value = t.stanza;
    document.getElementById('edit-t-frequenza').value = t.freq;
    document.getElementById('edit-t-ultima').value = t.ultima;
    document.getElementById('modal-edit-task').style.display = 'flex';
};

// 3. LOGICA DI SALVATAGGIO MODIFICA
document.getElementById('btn-update-task').onclick = async () => {
    const id = document.getElementById('edit-t-id').value;
    const data = {
        nome: document.getElementById('edit-t-nome').value,
        stanza: document.getElementById('edit-t-stanza').value,
        freq: parseInt(document.getElementById('edit-t-frequenza').value),
        ultima: document.getElementById('edit-t-ultima').value
    };
    await updateDoc(doc(db, "tasks", id), data);
    document.getElementById('modal-edit-task').style.display = 'none';
};
